name: 'Deploy'
on: push

jobs:
  deploy:
    if: startsWith(github.repository, 'MelanX/') # don't run this in forks
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2

      - name: 'Cache'
        id: cache
        uses: actions/cache/restore@v3
        with:
          path: .image_cache
          key: ${{ runner.os }}-image-cache-${{ hashFiles('**/*.png') }}

      - name: 'Install'
        run: sudo apt-get install -y python3 python3-pip optipng

      - name: 'Configure'
        run: pip3 install mkdocs==1.4.2 mkdocs-material==9.1.2

      - name: 'Optimize Images'
        run: |
          find . -path "./.image_cache" -prune -o -name "*.png" -type f -print | while read -r file; do
            cache_file="./.image_cache/${file#./}"
            if [ ! -f "$cache_file" ]; then
              mkdir -p "$(dirname "$cache_file")"
              echo "Adding $file to cache"
              cp "$file" "$cache_file"
            fi

            if [ "$file" -nt "$cache_file" ]; then
              echo "Optimizing $file"
              optipng -o7 "$file"
              cp "$file" "$cache_file"
            else
              echo "Skipping $file (already optimized)"
            fi
          done

      - uses: stefanzweifel/git-auto-commit-action@v4
        name: 'Push images'
        with:
          commit_message: 'Optimize images'
          commit_user_email: 'info@melanx.de'

      - name: 'Build Wiki'
        run: mkdocs build -d build_site

      - name: 'Modify pages'
        run: python modify_pages.py

      - name: 'Deploy'
        uses: 'JamesIves/github-pages-deploy-action@4.1.4'
        with:
          branch: gh-pages
          folder: 'build_site'
          clean: true
          git-config-name: 'Github Actions'
          git-config-email: 'info@melanx.de'

      - name: 'Save Cache'
        uses: actions/cache/save@v3
        with:
          path: .image_cache
          key: ${{ runner.os }}-image-cache-${{ hashFiles('**/*.png') }}
